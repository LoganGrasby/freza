<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>freza</title>
<style>
/* ── Reset & Base ─────────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-0: #0a0a0b;
  --bg-1: #111113;
  --bg-2: #1a1a1e;
  --bg-3: #222228;
  --bg-hover: #2a2a32;
  --border: #2a2a32;
  --border-subtle: #1e1e24;
  --text-0: #f0f0f2;
  --text-1: #b0b0b8;
  --text-2: #707078;
  --text-3: #505058;
  --accent: #7c6ff7;
  --accent-dim: #5a50b4;
  --accent-glow: rgba(124, 111, 247, 0.15);
  --green: #4ade80;
  --green-dim: rgba(74, 222, 128, 0.15);
  --amber: #fbbf24;
  --amber-dim: rgba(251, 191, 36, 0.15);
  --red: #f87171;
  --red-dim: rgba(248, 113, 113, 0.15);
  --blue: #60a5fa;
  --blue-dim: rgba(96, 165, 250, 0.15);
  --radius: 10px;
  --radius-sm: 6px;
  --radius-lg: 14px;
  --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  --shadow: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
  --transition: 150ms cubic-bezier(0.4, 0, 0.2, 1);
}

@font-face {
  font-family: 'Inter';
  src: url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
}

html, body {
  height: 100%;
  font-family: var(--font);
  background: var(--bg-0);
  color: var(--text-0);
  font-size: 14px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  overflow: hidden;
}

/* ── Layout ───────────────────────────────────────────────────────── */
.app {
  display: flex;
  height: 100vh;
}

/* ── Sidebar ──────────────────────────────────────────────────────── */
.sidebar {
  width: 56px;
  background: var(--bg-1);
  border-right: 1px solid var(--border-subtle);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 16px 0;
  gap: 4px;
  flex-shrink: 0;
}

.sidebar-logo {
  width: 32px;
  height: 32px;
  background: var(--accent);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 14px;
  margin-bottom: 20px;
  color: white;
}

.sidebar-btn {
  width: 40px;
  height: 40px;
  border: none;
  background: transparent;
  color: var(--text-2);
  border-radius: var(--radius);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition);
  position: relative;
}

.sidebar-btn:hover { background: var(--bg-3); color: var(--text-1); }
.sidebar-btn.active { color: var(--accent); background: var(--accent-glow); }
.sidebar-btn.active::before {
  content: '';
  position: absolute;
  left: -8px;
  width: 3px;
  height: 20px;
  background: var(--accent);
  border-radius: 0 2px 2px 0;
}

.sidebar-btn svg { width: 20px; height: 20px; }

.sidebar-spacer { flex: 1; }

/* ── Main Panels ──────────────────────────────────────────────────── */
.panel {
  flex: 1;
  display: none;
  flex-direction: column;
  min-width: 0;
}

.panel.active { display: flex; }

/* ── Chat Panel ───────────────────────────────────────────────────── */
.chat-header {
  height: 56px;
  border-bottom: 1px solid var(--border-subtle);
  display: flex;
  align-items: center;
  padding: 0 24px;
  gap: 12px;
  flex-shrink: 0;
}

.chat-header h2 {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-0);
}

.chat-header .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
}

.chat-header .status-text {
  font-size: 12px;
  color: var(--text-2);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.chat-messages::-webkit-scrollbar { width: 6px; }
.chat-messages::-webkit-scrollbar-track { background: transparent; }
.chat-messages::-webkit-scrollbar-thumb { background: var(--bg-3); border-radius: 3px; }

.msg {
  max-width: 720px;
  display: flex;
  gap: 12px;
  animation: fadeIn 200ms ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.user { align-self: flex-end; flex-direction: row-reverse; }

.msg-avatar {
  width: 28px;
  height: 28px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  flex-shrink: 0;
  margin-top: 2px;
}

.msg.agent .msg-avatar { background: var(--accent-glow); color: var(--accent); }
.msg.user .msg-avatar { background: var(--bg-3); color: var(--text-1); }

.msg-content {
  padding: 10px 14px;
  border-radius: var(--radius-lg);
  font-size: 13.5px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-break: break-word;
}

.msg.agent .msg-content {
  background: var(--bg-2);
  border: 1px solid var(--border-subtle);
  color: var(--text-0);
  border-top-left-radius: 4px;
}

.msg.user .msg-content {
  background: var(--accent);
  color: white;
  border-top-right-radius: 4px;
}

.msg-content code {
  font-family: var(--mono);
  font-size: 12.5px;
  background: rgba(0,0,0,0.25);
  padding: 1px 5px;
  border-radius: 4px;
}

.msg-content pre {
  background: rgba(0,0,0,0.3);
  padding: 12px;
  border-radius: var(--radius-sm);
  overflow-x: auto;
  margin: 8px 0;
}

.msg-content pre code {
  background: none;
  padding: 0;
}

.msg-time {
  font-size: 11px;
  color: var(--text-3);
  margin-top: 4px;
  padding: 0 4px;
}

.msg.user .msg-time { text-align: right; }

.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 4px 0;
}

.typing-indicator span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-2);
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
  30% { opacity: 1; transform: scale(1); }
}

/* ── Chat Input ───────────────────────────────────────────────────── */
.chat-input-area {
  border-top: 1px solid var(--border-subtle);
  padding: 16px 24px;
  flex-shrink: 0;
}

.chat-input-wrapper {
  display: flex;
  gap: 10px;
  align-items: flex-end;
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 8px 12px;
  transition: border-color var(--transition);
}

.chat-input-wrapper:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.chat-input {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: var(--text-0);
  font-family: var(--font);
  font-size: 14px;
  line-height: 1.5;
  resize: none;
  min-height: 24px;
  max-height: 160px;
}

.chat-input::placeholder { color: var(--text-3); }

.send-btn {
  width: 34px;
  height: 34px;
  border: none;
  background: var(--accent);
  color: white;
  border-radius: var(--radius);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition);
  flex-shrink: 0;
}

.send-btn:hover { background: var(--accent-dim); transform: scale(1.05); }
.send-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
.send-btn svg { width: 16px; height: 16px; }

/* ── Diagnostics Panel ────────────────────────────────────────────── */
.diag-container {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.diag-nav {
  width: 200px;
  background: var(--bg-1);
  border-right: 1px solid var(--border-subtle);
  padding: 16px 8px;
  display: flex;
  flex-direction: column;
  gap: 2px;
  flex-shrink: 0;
}

.diag-nav-item {
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 13px;
  color: var(--text-1);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
}

.diag-nav-item:hover { background: var(--bg-3); color: var(--text-0); }
.diag-nav-item.active { background: var(--accent-glow); color: var(--accent); }
.diag-nav-item svg { width: 16px; height: 16px; opacity: 0.7; }

.diag-content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.diag-content::-webkit-scrollbar { width: 6px; }
.diag-content::-webkit-scrollbar-track { background: transparent; }
.diag-content::-webkit-scrollbar-thumb { background: var(--bg-3); border-radius: 3px; }

.diag-section { display: none; }
.diag-section.active { display: block; }

/* ── Stats Cards ──────────────────────────────────────────────────── */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--bg-2);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius);
  padding: 16px;
}

.stat-card .label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-2);
  margin-bottom: 6px;
}

.stat-card .value {
  font-size: 24px;
  font-weight: 600;
  color: var(--text-0);
}

.stat-card .value.accent { color: var(--accent); }
.stat-card .value.green { color: var(--green); }
.stat-card .value.amber { color: var(--amber); }

/* ── Tables ───────────────────────────────────────────────────────── */
.data-table {
  width: 100%;
  border-collapse: collapse;
}

.data-table th {
  text-align: left;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-2);
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  font-weight: 500;
  position: sticky;
  top: 0;
  background: var(--bg-1);
}

.data-table td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-subtle);
  font-size: 13px;
  color: var(--text-1);
  vertical-align: top;
}

.data-table tr { transition: background var(--transition); }
.data-table tr:hover { background: var(--bg-hover); }
.data-table tr.clickable { cursor: pointer; }

/* ── Tags / Badges ────────────────────────────────────────────────── */
.tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 500;
}

.tag.green { background: var(--green-dim); color: var(--green); }
.tag.amber { background: var(--amber-dim); color: var(--amber); }
.tag.red { background: var(--red-dim); color: var(--red); }
.tag.blue { background: var(--blue-dim); color: var(--blue); }
.tag.neutral { background: var(--bg-3); color: var(--text-2); }

/* ── Memory View ──────────────────────────────────────────────────── */
.memory-view {
  background: var(--bg-2);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius);
  padding: 20px;
  font-family: var(--mono);
  font-size: 12.5px;
  line-height: 1.7;
  color: var(--text-1);
  white-space: pre-wrap;
  word-break: break-word;
  max-height: calc(100vh - 140px);
  overflow-y: auto;
}

.memory-view::-webkit-scrollbar { width: 6px; }
.memory-view::-webkit-scrollbar-track { background: transparent; }
.memory-view::-webkit-scrollbar-thumb { background: var(--bg-3); border-radius: 3px; }

/* ── Log Detail Modal ─────────────────────────────────────────────── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 150ms ease;
}

.modal {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 90vw;
  max-width: 900px;
  max-height: 85vh;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-lg);
}

.modal-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-subtle);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-header h3 {
  font-size: 15px;
  font-weight: 600;
}

.modal-close {
  width: 32px;
  height: 32px;
  border: none;
  background: var(--bg-3);
  color: var(--text-1);
  border-radius: var(--radius-sm);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition);
}

.modal-close:hover { background: var(--red-dim); color: var(--red); }

.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.modal-body::-webkit-scrollbar { width: 6px; }
.modal-body::-webkit-scrollbar-track { background: transparent; }
.modal-body::-webkit-scrollbar-thumb { background: var(--bg-3); border-radius: 3px; }

.detail-grid {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 8px 16px;
  margin-bottom: 20px;
}

.detail-grid .label {
  font-size: 12px;
  color: var(--text-2);
  font-weight: 500;
}

.detail-grid .value {
  font-size: 13px;
  color: var(--text-0);
}

.conversation-view {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.conv-turn {
  background: var(--bg-2);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius);
  padding: 12px;
}

.conv-turn .role {
  font-size: 11px;
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.05em;
  margin-bottom: 6px;
}

.conv-turn.assistant .role { color: var(--accent); }
.conv-turn.user .role { color: var(--green); }
.conv-turn.system .role { color: var(--amber); }
.conv-turn.result .role { color: var(--blue); }

.conv-turn .content {
  font-size: 12.5px;
  font-family: var(--mono);
  line-height: 1.6;
  color: var(--text-1);
  white-space: pre-wrap;
  word-break: break-word;
  max-height: 300px;
  overflow-y: auto;
}

/* ── Section headers ──────────────────────────────────────────────── */
.section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-0);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title .refresh-btn {
  width: 24px;
  height: 24px;
  border: none;
  background: var(--bg-3);
  color: var(--text-2);
  border-radius: var(--radius-sm);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition);
}

.section-title .refresh-btn:hover { color: var(--accent); }
.section-title .refresh-btn svg { width: 14px; height: 14px; }

/* ── Empty state ──────────────────────────────────────────────────── */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 60px 20px;
  color: var(--text-2);
}

.empty-state svg { width: 40px; height: 40px; opacity: 0.3; }
.empty-state p { font-size: 14px; }

/* ── Tool tags ────────────────────────────────────────────────────── */
.tool-tags {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.tool-tag {
  font-family: var(--mono);
  font-size: 10px;
  padding: 1px 6px;
  background: var(--bg-3);
  color: var(--text-2);
  border-radius: 4px;
}

/* ── Welcome ──────────────────────────────────────────────────────── */
.welcome {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding: 40px;
}

.welcome-icon {
  width: 64px;
  height: 64px;
  background: var(--accent-glow);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.welcome-icon svg { width: 32px; height: 32px; color: var(--accent); }

.welcome h2 {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-0);
}

.welcome p {
  font-size: 14px;
  color: var(--text-2);
  max-width: 400px;
  text-align: center;
}

/* ── Scrollbar for body ───────────────────────────────────────────── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg-3); border-radius: 3px; }
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-logo">F</div>
    <button class="sidebar-btn active" data-panel="chat" title="Chat">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
      </svg>
    </button>
    <button class="sidebar-btn" data-panel="diag" title="Diagnostics">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
    </button>
    <div class="sidebar-spacer"></div>
    <button class="sidebar-btn" id="theme-btn" title="Toggle theme">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    </button>
  </nav>

  <!-- Chat Panel -->
  <div class="panel active" id="panel-chat">
    <div class="chat-header">
      <div class="status-dot" id="status-dot"></div>
      <h2>freza</h2>
      <span class="status-text" id="status-text">ready</span>
    </div>

    <div class="chat-messages" id="chat-messages">
      <div class="welcome" id="welcome">
        <div class="welcome-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
          </svg>
        </div>
        <h2>Welcome</h2>
        <p>Send a message to your autonomous agent. It has full access to bash, file editing, web search, and more.</p>
      </div>
    </div>

    <div class="chat-input-area">
      <div class="chat-input-wrapper">
        <textarea class="chat-input" id="chat-input" placeholder="Message your agent..." rows="1"></textarea>
        <button class="send-btn" id="send-btn" title="Send">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Diagnostics Panel -->
  <div class="panel" id="panel-diag">
    <div class="chat-header">
      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      <h2>Diagnostics</h2>
    </div>
    <div class="diag-container">
      <div class="diag-nav">
        <div class="diag-nav-item active" data-section="overview">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          Overview
        </div>
        <div class="diag-nav-item" data-section="logs">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Logs
        </div>
        <div class="diag-nav-item" data-section="instances">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
          Instances
        </div>
        <div class="diag-nav-item" data-section="memory">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
          Memory
        </div>
        <div class="diag-nav-item" data-section="channels">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
          Channels
        </div>
      </div>
      <div class="diag-content">
        <!-- Overview Section -->
        <div class="diag-section active" id="section-overview">
          <div class="section-title">
            System Overview
            <button class="refresh-btn" onclick="loadOverview()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-1.98-9.74L23 10"/></svg>
            </button>
          </div>
          <div class="stats-grid" id="stats-grid"></div>
        </div>

        <!-- Logs Section -->
        <div class="diag-section" id="section-logs">
          <div class="section-title">
            Run History
            <button class="refresh-btn" onclick="loadLogs()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-1.98-9.74L23 10"/></svg>
            </button>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Channel</th>
                <th>Duration</th>
                <th>Cost</th>
                <th>Turns</th>
                <th>Tools</th>
                <th>Trigger</th>
              </tr>
            </thead>
            <tbody id="logs-tbody"></tbody>
          </table>
        </div>

        <!-- Instances Section -->
        <div class="diag-section" id="section-instances">
          <div class="section-title">
            Active Instances
            <button class="refresh-btn" onclick="loadInstances()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-1.98-9.74L23 10"/></svg>
            </button>
          </div>
          <div id="instances-content"></div>
        </div>

        <!-- Memory Section -->
        <div class="diag-section" id="section-memory">
          <div class="section-title">
            Long-Term Memory
            <button class="refresh-btn" onclick="loadMemory()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-1.98-9.74L23 10"/></svg>
            </button>
          </div>
          <div class="memory-view" id="memory-content"></div>
        </div>

        <!-- Channels Section -->
        <div class="diag-section" id="section-channels">
          <div class="section-title">
            Registered Channels
            <button class="refresh-btn" onclick="loadChannels()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-1.98-9.74L23 10"/></svg>
            </button>
          </div>
          <div id="channels-content"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Log Detail Modal -->
<div class="modal-overlay" id="log-modal" style="display:none">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-title">Log Detail</h3>
      <button class="modal-close" onclick="closeModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<script>
// ── State ──────────────────────────────────────────────────────────
let streaming = false;
let currentProcId = null;

// ── DOM Refs ───────────────────────────────────────────────────────
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const statusDot = document.getElementById('status-dot');
const statusText = document.getElementById('status-text');
const welcome = document.getElementById('welcome');

// ── Panel Switching ────────────────────────────────────────────────
document.querySelectorAll('.sidebar-btn[data-panel]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('panel-' + btn.dataset.panel).classList.add('active');

    // Load data when switching to diagnostics
    if (btn.dataset.panel === 'diag') {
      loadOverview();
      loadActiveDiagSection();
    }
  });
});

// ── Diag Nav Switching ─────────────────────────────────────────────
document.querySelectorAll('.diag-nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.diag-nav-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll('.diag-section').forEach(s => s.classList.remove('active'));
    item.classList.add('active');
    document.getElementById('section-' + item.dataset.section).classList.add('active');
    loadActiveDiagSection();
  });
});

function loadActiveDiagSection() {
  const active = document.querySelector('.diag-nav-item.active');
  if (!active) return;
  const s = active.dataset.section;
  if (s === 'overview') loadOverview();
  else if (s === 'logs') loadLogs();
  else if (s === 'instances') loadInstances();
  else if (s === 'memory') loadMemory();
  else if (s === 'channels') loadChannels();
}

// ── Chat ───────────────────────────────────────────────────────────
chatInput.addEventListener('input', () => {
  chatInput.style.height = 'auto';
  chatInput.style.height = Math.min(chatInput.scrollHeight, 160) + 'px';
});

chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

sendBtn.addEventListener('click', sendMessage);

async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text || streaming) return;

  if (welcome) welcome.remove();

  // Add user message
  addMessage('user', text);
  chatInput.value = '';
  chatInput.style.height = 'auto';

  // Set streaming state
  streaming = true;
  sendBtn.disabled = true;
  setStatus('thinking', 'amber');

  try {
    // Start agent
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text }),
    });

    const data = await res.json();
    if (!data.proc_id) throw new Error('No proc_id returned');

    currentProcId = data.proc_id;
    setStatus('streaming', 'green');

    // Stream response via SSE
    const agentMsg = addMessage('agent', '');
    const contentEl = agentMsg.querySelector('.msg-content');
    let fullText = '';

    const evtSource = new EventSource('/api/stream/' + data.proc_id);

    evtSource.onmessage = (event) => {
      const d = JSON.parse(event.data);
      if (d.done) {
        evtSource.close();
        streaming = false;
        sendBtn.disabled = false;
        currentProcId = null;
        setStatus('ready', 'green');

        if (!fullText.trim()) {
          contentEl.textContent = '(Agent completed with no text output)';
        }
        return;
      }
      if (d.text) {
        fullText += d.text;
        contentEl.textContent = fullText;
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    };

    evtSource.onerror = () => {
      evtSource.close();
      streaming = false;
      sendBtn.disabled = false;
      setStatus('ready', 'green');
      if (!fullText.trim()) {
        contentEl.textContent = '(Connection lost)';
      }
    };

  } catch (err) {
    addMessage('agent', 'Error: ' + err.message);
    streaming = false;
    sendBtn.disabled = false;
    setStatus('error', 'red');
    setTimeout(() => setStatus('ready', 'green'), 3000);
  }
}

function addMessage(role, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;

  const now = new Date();
  const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  div.innerHTML = `
    <div class="msg-avatar">${role === 'agent' ? 'F' : 'Y'}</div>
    <div>
      <div class="msg-content">${escapeHtml(text)}</div>
      <div class="msg-time">${time}</div>
    </div>
  `;

  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div;
}

function setStatus(text, color) {
  statusText.textContent = text;
  statusDot.style.background = `var(--${color})`;
  statusDot.style.boxShadow = `0 0 8px var(--${color})`;
}

// ── Diagnostics Loaders ────────────────────────────────────────────
async function loadOverview() {
  try {
    const [stats, instances] = await Promise.all([
      fetch('/api/stats').then(r => r.json()),
      fetch('/api/instances').then(r => r.json()),
    ]);

    const grid = document.getElementById('stats-grid');
    grid.innerHTML = `
      <div class="stat-card">
        <div class="label">Total Runs</div>
        <div class="value accent">${stats.total_runs}</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Cost</div>
        <div class="value">$${stats.total_cost_usd.toFixed(2)}</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Duration</div>
        <div class="value">${formatDuration(stats.total_duration_s)}</div>
      </div>
      <div class="stat-card">
        <div class="label">Active Instances</div>
        <div class="value green">${instances.length}</div>
      </div>
      ${Object.entries(stats.channel_counts).map(([ch, count]) => `
        <div class="stat-card">
          <div class="label">${ch} runs</div>
          <div class="value">${count}</div>
        </div>
      `).join('')}
    `;
  } catch (e) {
    console.error('Failed to load overview:', e);
  }
}

async function loadLogs() {
  try {
    const logs = await fetch('/api/logs?limit=100').then(r => r.json());
    const tbody = document.getElementById('logs-tbody');
    tbody.innerHTML = logs.map(log => `
      <tr class="clickable" onclick="openLogDetail('${log.file}')">
        <td>${formatTimestamp(log.timestamp)}</td>
        <td><span class="tag ${log.channel === 'webui' ? 'blue' : 'neutral'}">${log.channel || log.mode}</span></td>
        <td>${log.duration ? log.duration.toFixed(1) + 's' : '-'}</td>
        <td>${log.cost ? '$' + log.cost.toFixed(4) : '-'}</td>
        <td>${log.turns || '-'}</td>
        <td><div class="tool-tags">${(log.tools || []).slice(0, 5).map(t => `<span class="tool-tag">${t}</span>`).join('')}${(log.tools || []).length > 5 ? `<span class="tool-tag">+${log.tools.length - 5}</span>` : ''}</div></td>
        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(log.trigger || '')}</td>
      </tr>
    `).join('');
  } catch (e) {
    console.error('Failed to load logs:', e);
  }
}

async function loadInstances() {
  try {
    const [instances, shortTerm] = await Promise.all([
      fetch('/api/instances').then(r => r.json()),
      fetch('/api/short-term').then(r => r.json()),
    ]);

    const container = document.getElementById('instances-content');

    if (instances.length === 0 && shortTerm.length === 0) {
      container.innerHTML = `<div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <p>No active instances</p>
      </div>`;
      return;
    }

    let html = '<table class="data-table"><thead><tr><th>Instance</th><th>Mode</th><th>Channel</th><th>Status</th><th>Task</th><th>Started</th></tr></thead><tbody>';

    const allData = [...instances.map(i => ({
      id: i.instance_id,
      mode: i.mode,
      channel: i.channel_name,
      status: i.status || 'running',
      task: null,
      started: i.started_at,
    }))];

    // Merge short-term data
    shortTerm.forEach(st => {
      const existing = allData.find(d => d.id === st.instance_id);
      if (existing) {
        existing.task = st.current_task;
        existing.status = st.status || existing.status;
      } else {
        allData.push({
          id: st.instance_id,
          mode: st.mode,
          channel: st.channel_name,
          status: st.status || 'unknown',
          task: st.current_task,
          started: st.started_at,
        });
      }
    });

    allData.forEach(d => {
      const statusClass = d.status === 'running' ? 'green' : d.status === 'failed' ? 'red' : 'neutral';
      html += `<tr>
        <td><code style="font-family:var(--mono);font-size:12px">${d.id ? d.id.slice(0, 12) : '-'}</code></td>
        <td>${d.mode || '-'}</td>
        <td>${d.channel || '-'}</td>
        <td><span class="tag ${statusClass}">${d.status}</span></td>
        <td>${d.task || '-'}</td>
        <td>${d.started ? formatTimestamp(d.started) : '-'}</td>
      </tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    console.error('Failed to load instances:', e);
  }
}

async function loadMemory() {
  try {
    const data = await fetch('/api/memory').then(r => r.json());
    document.getElementById('memory-content').textContent = data.content || '(empty)';
  } catch (e) {
    console.error('Failed to load memory:', e);
  }
}

async function loadChannels() {
  try {
    const channels = await fetch('/api/channels').then(r => r.json());
    const container = document.getElementById('channels-content');

    if (channels.length === 0) {
      container.innerHTML = '<div class="empty-state"><p>No channels registered</p></div>';
      return;
    }

    let html = '<table class="data-table"><thead><tr><th>Name</th><th>Description</th><th>Created</th></tr></thead><tbody>';
    channels.forEach(ch => {
      html += `<tr>
        <td><span class="tag blue">${ch.name}</span></td>
        <td>${escapeHtml(ch.description || '')}</td>
        <td>${ch.created_at ? formatTimestamp(ch.created_at) : '-'}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    console.error('Failed to load channels:', e);
  }
}

// ── Log Detail Modal ───────────────────────────────────────────────
async function openLogDetail(filename) {
  try {
    const data = await fetch('/api/logs/' + filename).then(r => r.json());
    const modal = document.getElementById('log-modal');
    const title = document.getElementById('modal-title');
    const body = document.getElementById('modal-body');

    title.textContent = 'Run: ' + (data.instance_id || filename).slice(0, 16);

    let html = '<div class="detail-grid">';
    html += `<div class="label">Instance ID</div><div class="value"><code style="font-family:var(--mono)">${data.instance_id || '-'}</code></div>`;
    html += `<div class="label">Mode</div><div class="value">${data.mode || '-'}</div>`;
    html += `<div class="label">Channel</div><div class="value">${data.channel_name || '-'}</div>`;
    html += `<div class="label">Duration</div><div class="value">${data.duration_seconds ? data.duration_seconds.toFixed(1) + 's' : '-'}</div>`;
    html += `<div class="label">Cost</div><div class="value">${data.cost_usd ? '$' + data.cost_usd.toFixed(4) : '-'}</div>`;
    html += `<div class="label">Turns</div><div class="value">${data.turns || '-'}</div>`;
    html += `<div class="label">Tools Used</div><div class="value"><div class="tool-tags">${(data.tools_used || []).map(t => `<span class="tool-tag">${t}</span>`).join('')}</div></div>`;
    html += '</div>';

    // Trigger
    if (data.trigger_message) {
      html += '<div class="section-title" style="margin-top:16px">Trigger</div>';
      html += `<div style="background:var(--bg-2);border:1px solid var(--border-subtle);border-radius:var(--radius);padding:12px;font-family:var(--mono);font-size:12.5px;color:var(--text-1);white-space:pre-wrap;margin-bottom:16px">${escapeHtml(data.trigger_message)}</div>`;
    }

    // Response
    if (data.response) {
      html += '<div class="section-title">Response</div>';
      html += `<div style="background:var(--bg-2);border:1px solid var(--border-subtle);border-radius:var(--radius);padding:12px;font-family:var(--mono);font-size:12.5px;color:var(--text-1);white-space:pre-wrap;margin-bottom:16px;max-height:300px;overflow-y:auto">${escapeHtml(data.response)}</div>`;
    }

    // Conversation
    if (data.conversation && data.conversation.length > 0) {
      html += '<div class="section-title">Conversation Trace</div>';
      html += '<div class="conversation-view">';
      data.conversation.forEach(turn => {
        const role = turn.role || 'unknown';
        let content = '';

        if (role === 'assistant' && Array.isArray(turn.content)) {
          turn.content.forEach(block => {
            if (block.type === 'text') {
              content += block.text + '\n';
            } else if (block.type === 'tool_use') {
              content += `[Tool: ${block.name}]\n${JSON.stringify(block.input, null, 2).slice(0, 500)}\n`;
            }
          });
        } else if (role === 'user' && Array.isArray(turn.content)) {
          turn.content.forEach(block => {
            if (block.type === 'tool_result') {
              const out = typeof block.content === 'string' ? block.content : JSON.stringify(block.content);
              content += `[Result for: ${block.tool_use_id?.slice(0, 12)}]\n${(out || '').slice(0, 500)}\n`;
            }
          });
        } else if (role === 'system') {
          content = JSON.stringify(turn.data || turn, null, 2).slice(0, 500);
        } else if (role === 'result') {
          content = JSON.stringify(turn, null, 2);
        }

        if (content.trim()) {
          html += `<div class="conv-turn ${role}">
            <div class="role">${role}${turn.subtype ? ' (' + turn.subtype + ')' : ''}${turn.model ? ' · ' + turn.model : ''}</div>
            <div class="content">${escapeHtml(content.trim())}</div>
          </div>`;
        }
      });
      html += '</div>';
    }

    body.innerHTML = html;
    modal.style.display = 'flex';
  } catch (e) {
    console.error('Failed to load log detail:', e);
  }
}

function closeModal() {
  document.getElementById('log-modal').style.display = 'none';
}

document.getElementById('log-modal').addEventListener('click', (e) => {
  if (e.target.id === 'log-modal') closeModal();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

// ── Helpers ────────────────────────────────────────────────────────
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatTimestamp(ts) {
  if (!ts) return '-';
  const d = new Date(ts * 1000);
  const now = new Date();
  const diff = (now - d) / 1000;

  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatDuration(seconds) {
  if (!seconds) return '-';
  if (seconds < 60) return seconds.toFixed(0) + 's';
  if (seconds < 3600) return Math.floor(seconds / 60) + 'm ' + (seconds % 60).toFixed(0) + 's';
  return Math.floor(seconds / 3600) + 'h ' + Math.floor((seconds % 3600) / 60) + 'm';
}

// ── Init ───────────────────────────────────────────────────────────
chatInput.focus();
</script>
</body>
</html>
